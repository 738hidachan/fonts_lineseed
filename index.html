<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>LINE Seed JP Font Viewer Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LINE+Seed+JP:wght@100;400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --line-green: #06C755; --bg: #f4f7f6; }
        * { box-sizing: border-box; }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'LINE Seed JP', sans-serif;
            background-color: var(--bg); overflow: hidden;
            position: fixed; /* iOSのスクロールバウンス対策 */
        }

        /* 設定パネル：自動開閉 */
        header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: #fff; padding: 20px; z-index: 2000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .panel-hidden { transform: translateY(-100%); }

        .container { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
        @media (min-width: 768px) {
            .container { flex-direction: row; align-items: flex-end; }
        }

        .field { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 11px; font-weight: 800; color: var(--line-green); }

        input, select {
            width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px;
            font-size: 16px; font-family: inherit; background: #fff;
        }

        button.apply-btn {
            background: var(--line-green); color: white; border: none;
            padding: 12px 24px; border-radius: 12px; font-weight: 800;
            cursor: pointer; font-size: 16px; min-width: 120px;
        }

        /* フローティング再設定ボタン */
        #reopen-btn {
            position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px;
            background: var(--line-green); border-radius: 50%; color: white;
            border: none; z-index: 2001; cursor: pointer; display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); font-size: 24px;
        }

        /* 究極のビューワー設定 */
        #viewer-container {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: #fff;
        }

        iframe {
            width: 100% !important; height: 100% !important;
            border: none; display: none;
            /* iOS Safariでのiframe膨張バグを物理的に抑え込む */
            max-width: 100% !important;
        }

        .loading {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 3000;
        }
        .spinner { width: 32px; height: 32px; border: 3px solid #eee; border-top-color: var(--line-green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header id="panel">
    <div class="container">
        <div class="field">
            <label>サイトのURL</label>
            <input type="url" id="url-input" placeholder="https://www.nodayoshi.gr.jp/..." value="">
        </div>
        <div class="field" style="max-width: 140px;">
            <label>太さ</label>
            <select id="weight-input">
                <option value="100">極細</option>
                <option value="400" selected>標準</option>
                <option value="700">太め</option>
                <option value="800">超極太</option>
            </select>
        </div>
        <button class="apply-btn" onclick="startViewing()">適用</button>
    </div>
</header>

<button id="reopen-btn" onclick="showPanel()">⚙</button>

<div id="viewer-container">
    <div id="intro-msg" style="color:#aaa; font-weight:700;">URLを入力してください</div>
    <iframe id="target-frame" name="target-frame"></iframe>
</div>

<div id="loading-overlay" class="loading">
    <div class="spinner"></div>
    <p style="margin-top:12px; font-weight:700; font-size:14px; color:#555;">サイトを最適化中...</p>
</div>

<script>
    function showPanel() {
        document.getElementById('panel').classList.remove('panel-hidden');
        document.getElementById('reopen-btn').style.display = 'none';
    }

    async function startViewing() {
        const urlValue = document.getElementById('url-input').value.trim();
        const weight = document.getElementById('weight-input').value;
        const frame = document.getElementById('target-frame');
        const overlay = document.getElementById('loading-overlay');
        
        if (!urlValue) return alert('URLを入力してください');
        
        const targetUrl = urlValue.startsWith('http') ? urlValue : 'https://' + urlValue;
        overlay.style.display = 'flex';

        try {
            // AllOriginsプロキシを使用
            const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
            const response = await fetch(proxy);
            const data = await response.json();
            let html = data.contents;
            const baseUrl = new URL(targetUrl).origin;

            // --- 根本的な解決：レスポンシブ崩れを防ぐための処理 ---
            
            // 1. サイト自身のviewportを徹底的に排除し、こちらで再定義する
            html = html.replace(/<meta[^>]*name=["']viewport["'][^>]*>/gi, '');
            
            // 2. セキュリティ制約（CSP）による画像・CSSの読み込みエラーを防ぐため、<base>タグを最優先で挿入
            // 3. iPhone/Android共通で「100%幅」を維持させるCSSを注入
            const customHead = `
                <base href="${baseUrl}/">
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
                <link href="https://fonts.googleapis.com/css2?family=LINE+Seed+JP:wght@${weight}&display=swap" rel="stylesheet">
                <style>
                    /* 全ての要素にフォントを強制適用 */
                    *, *::before, *::after {
                        font-family: 'LINE Seed JP', sans-serif !important;
                        font-weight: ${weight} !important;
                    }
                    /* iPhoneでの横揺れ・はみ出しを物理的に禁止する */
                    html, body {
                        width: 100% !important;
                        overflow-x: hidden !important;
                        position: relative !important;
                        margin: 0 !important;
                        padding: 0 !important;
                        -webkit-text-size-adjust: 100% !important;
                    }
                    /* 画像が画面を突き破るのを防ぐ */
                    img, table, div, section {
                        max-width: 100% !important;
                        box-sizing: border-box !important;
                    }
                </style>
            `;

            // <head>が存在しない不規則なサイトにも対応
            if (html.toLowerCase().includes('<head>')) {
                html = html.replace(/<head>/i, '<head>' + customHead);
            } else {
                html = customHead + html;
            }

            // 4. 書き込みと表示
            document.getElementById('intro-msg').style.display = 'none';
            frame.style.display = 'block';
            frame.srcdoc = html;

            // 5. 適用完了後にパネルを自動的に隠す
            setTimeout(() => {
                document.getElementById('panel').classList.add('panel-hidden');
                document.getElementById('reopen-btn').style.display = 'flex';
                overlay.style.display = 'none';
            }, 1000);

        } catch (e) {
            alert('サイトの読み込みに失敗しました。');
            overlay.style.display = 'none';
        }
    }
</script>
</body>
</html>
